<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CODERROR</title>
    <style>
        *{
            margin:0;
            padding:0;
        }
        html,body{
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            overflow:hidden;
            background-color:#000;
        }
        canvas{
            display:block;
        }
        @font-face{
            font-family:'CODERROR';
            src:url('fonts/CODERROR.ttf')format('truetype');
            font-weight:normal;
            font-style:normal;
            font-display:block;
        }
    </style>
    <link rel="icon" type="image/png">
</head>
<body>
    <script>
        //Проверяем, является ли это окно основным
        if(!window.location.search.includes('child=1')){
            //Параметры для нового окна
            const width=800;
            const height=600;
            const features=`width=${width},height=${height},left=${(screen.width-width)/2},top=${(screen.height-height)/2}`;
            //Пытаемся открыть новое окно
            const newWindow=window.open(`${window.location.href}?child=1`,'_blank',features);
            if (newWindow) {
                // Закрываем текущее окно после успешного открытия
                window.close();
            } else {
                // Проверяем браузер пользователя
                const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg|Edge/.test(navigator.userAgent);
                let chromeAlert = '';
                
                if (!isChrome) {
                    chromeAlert = `
                        <div style="padding: 15px; color: #000; background: #ffeb3b; margin-bottom: 10px; border-radius: 4px;">
                            Рекомендуется запускать в Google Chrome: 
                            <a href="https://www.google.com/intl/ru_ru/chrome/" 
                            target="_blank" 
                            style="color: #ff00ff; text-decoration: underline;">
                                https://www.google.com/intl/ru_ru/chrome/
                            </a>
                        </div>`;
                }

                // Формируем полное сообщение
                document.body.innerHTML = chromeAlert + `
                    <div style="padding: 20px; color: white; background: #d32f2f; border-radius: 4px;">
                        Разрешите всплывающие окна для этого сайта и обновите страницу!
                    </div>`;
            }
        }else{
            //Если это дочернее окно - загружаем приложение
            const script=document.createElement('script');
            script.src='scripts/pixi.min.js';
            //Предзагрузка шрифта
            const font=new FontFace('CODERROR','url(fonts/CODERROR.ttf)');
            font.load().then(function(loadedFont){
                document.fonts.add(loadedFont);
                //Запускаем загрузку Pixi только после загрузки шрифта
                document.head.appendChild(script);
            }).catch(function(error){
                console.error('Font loading failed:',error);
            });
            script.onload=function() {
                //Весь код приложения
                const app=new PIXI.Application({
                    backgroundColor:0x000000,
                });
                app.init().then(()=>{
                    document.body.appendChild(app.view);
                    const textStyle=new PIXI.TextStyle({
                        fontFamily:'CODERROR',
                        fontSize:10,
                        fill:0xFFFFFF,
                    });
                    let symbolsPool=[];
                    let columns=0;
                    let rows=0;
                    const updateSize=()=>{
                        app.renderer.resize(window.innerWidth,window.innerHeight);
                        calculateGrid();
                        updatePool();
                    };
                    function calculateGrid(){
                        columns=Math.ceil(app.renderer.width/10);
                        rows=Math.ceil(app.renderer.height/10);
                    }
                    function getRandomChar(){
                        return String.fromCharCode(Math.floor(Math.random()*(126-33+1))+33);
                    }
                    function getRandomColor(){
                        return Math.floor(Math.random()*0xFFFFFF);
                    }
                    //для иконки
                    const dpr=window.devicePixelRatio||1;
                    const baseSize=16;// Базовый размер в логических пикселях
                    const physicalSize=Math.round(baseSize * dpr);
                    const symbolSize=10;
                    const canvas=document.createElement('canvas');
                    canvas.width=physicalSize;
                    canvas.height=physicalSize;
                    const ctx=canvas.getContext('2d');
                    ctx.font=`${symbolSize}px CODERROR`;
                    ctx.textAlign='center';
                    ctx.textBaseline='middle';
                    const link=document.querySelector('link[rel="icon"]');
                    
                    function generateFavicon(){
                        // Очищаем холст
                        ctx.clearRect(0,0,physicalSize,physicalSize);
                        // Настройки текста
                        ctx.fillStyle=`#${getRandomColor().toString(16).padStart(6,'0')}`;
                        // Рисуем символ
                        ctx.fillText(getRandomChar(),physicalSize/2,physicalSize/2);
                        // Обновляем иконку
                        canvas.toBlob(blob => {
                            link.href = URL.createObjectURL(blob);
                        }, 'image/png');
                    }
                    function updatePool(){
                        const required=columns*rows;
                        while(symbolsPool.length<required){
                            const symbol=new PIXI.Text('',textStyle);
                            symbol.resolution=20;
                            symbol.visible=false;
                            app.stage.addChild(symbol);
                            symbolsPool.push(symbol);
                        }
                        let index=0;
                        for(let y=0;y<rows;y++){
                            for(let x=0;x<columns;x++){
                                const symbol=symbolsPool[index];
                                symbol.text=getRandomChar();
                                symbol.tint=getRandomColor();
                                symbol.position.set(x*10,y*10);
                                symbol.visible=true;
                                index++;
                            }
                        }
                        for(let i=index;i<symbolsPool.length;i++){
                            symbolsPool[i].visible=false;
                        }
                    }
                    updateSize();
                    window.addEventListener('resize',updateSize);
                    /*обновление favicon*/
                    const faviconInterval=setInterval(()=>{
                        generateFavicon();
                    },1000/5);
                    /*главный цикл*/
                    app.ticker.add(()=>{
                        updatePool();
                        document.title=`CODERROR FPS: ${app.ticker.FPS.toFixed(2)}`;
                    });
                    app.ticker.maxFPS=60;
                }).catch(console.error);
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html>